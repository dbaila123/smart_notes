
```sql 
CREATE PROCEDURE sp_get_endRequestDate

@nIds_Colaborador NVARCHAR(MAX),

@dFecha_Inicio DATE,

@nCant_Dias INT,

@nTipo_Solicitud INT

AS

BEGIN

SET NOCOUNT ON;

  

DECLARE @nId_Colaborador INT;

DECLARE @dFecha DATE;

DECLARE @nDias_Contados INT;

DECLARE @nId_Horario INT;

DECLARE @nDia INT;

  

-- Tabla para almacenar los resultados

CREATE TABLE #Resultados (

nId_Colaborador INT,

dFecha_Fin DATE

);

  

-- Tabla temporal para dividir la lista de IDs de colaboradores

CREATE TABLE #Colaboradores (nId_Colaborador INT);

  

-- Insertar los valores separados por coma en la tabla temporal

INSERT INTO #Colaboradores (nId_Colaborador)

SELECT value FROM STRING_SPLIT(@nIds_Colaborador, ',');

  

-- Recorrer cada colaborador

DECLARE cursorColaboradores CURSOR FOR

SELECT nId_Colaborador FROM #Colaboradores;

  

OPEN cursorColaboradores;

FETCH NEXT FROM cursorColaboradores INTO @nId_Colaborador;

  

WHILE @@FETCH_STATUS = 0

BEGIN

SET @dFecha = @dFecha_Inicio;

SET @nDias_Contados = 0;

DECLARE @affecDays INT

  

SET @affecDays = (SELECT count(*) from Tipos_Solicitudes

where nId_Tipo_Solicitud = @nTipo_Solicitud

and nTipo_Frecuencia = 2) --FRECUENCIA EN DIAS

  

-- Obtener el horario del colaborador

SELECT @nId_Horario = nId_Horario

FROM Horarios_Colaboradores

WHERE nId_Colaborador = @nId_Colaborador;

  

  

  

IF @nId_Horario IS NOT NULL AND @affecDays > 0

BEGIN

-- Iterar hasta contar nCant_Dias válidos

WHILE @nDias_Contados < @nCant_Dias

BEGIN

-- Obtener el número de día de la semana

SET @nDia = dbo.fn_get_weekday(@dFecha);

  

-- Verificar si el día existe en Horarios_Detalles para el horario del colaborador

IF EXISTS (

SELECT 1 FROM Horarios_Detalles

WHERE nId_Horario = @nId_Horario AND nDia = @nDia

)

BEGIN

-- Verificar si el día no está en la tabla de feriados

IF NOT EXISTS (

SELECT 1 FROM Feriados WHERE dFecha = @dFecha

)

BEGIN

SET @nDias_Contados = @nDias_Contados + 1; -- Contar como día válido

END

END

  

-- Si aún no se ha contado el total de días, avanzar al siguiente día

IF @nDias_Contados < @nCant_Dias

SET @dFecha = DATEADD(DAY, 1, @dFecha);

END

  

-- Insertar el resultado en la tabla temporal

INSERT INTO #Resultados (nId_Colaborador, dFecha_Fin)

VALUES (@nId_Colaborador, @dFecha);

END

ELSE

BEGIN

INSERT INTO #Resultados (nId_Colaborador, dFecha_Fin)

VALUES (@nId_Colaborador, @dFecha_Inicio);

end

FETCH NEXT FROM cursorColaboradores INTO @nId_Colaborador;

END

  

CLOSE cursorColaboradores;

DEALLOCATE cursorColaboradores;

  

-- Devolver los resultados

SELECT * FROM #Resultados;

  

-- Limpiar tablas temporales

DROP TABLE #Resultados;

DROP TABLE #Colaboradores;

END```

